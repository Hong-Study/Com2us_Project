# GameServer 설명

## 목차
1. [설명](#설명)
2. [서버 기능](#서버-기능)
3. [아키텍처](#아키텍처)
4. [주요 기능 구현](#주요-기능-구현)
5. [피드백](#피드백)
6. [트러블 슈팅](#트러블-슈팅)

## 설명
- Game Socket 서버입니다.
- 오목 게임에 관한 로직을 담당하고 있습니다.
- 멀티 스레드로 돌아가고 있으며, 스레드의 용도는 다음과 같습니다.
  - **로직 스레드 :** 싱글 스레드로써, 클라이언트의 패킷을 직접적으로 처리하는 스레드입니다.
  - **데이터베이스 스레드 :** 멀티 스레드로써, 데이터베이스의 처리를 비동기적으로 작업하기 위한 스레드입니다.
  - **레디스 스레드 :** 멀티 스레드로써, 레디스의 처리를 비동기적으로 작업하기 위한 스레드입니다.
  - **매칭 스레드 :** 싱글 스레드로써, 매칭 API 서버와 레디스로 통신을 담당하는 스레드입니다.
- 객체간의 연동을 최소화하기 위해 싱글톤을 전혀 사용하지 않고 델리게이트 형식으로 넘기는 방식으로 구현되어 있습니다.
- `MemoryPack` 라이브러리를 통해서 데이터를 직렬화하거나 역직렬화합니다.

| 종류         | 라이브러리                  |
| ------------ | --------------------------- |
| **Network**  | `SuperSocketLite`           |
| **Binary**   | `MemoryPack`                |
| **Database** | `MySqlConnector`, `SqlKata` |
| **Redis**    | `CloudStructures`           |
| **Logger**   | `NLog`                      |

## 서버 기능

### 유저 기능
|    **기능**    | **완료 여부** |
| :------------: | :-----------: |
|  유저 로그인   |     완료      |
| 유저 로그 아웃 |               |

### 게임 기능
|     **기능**     | **완료 여부** |
| :--------------: | :-----------: |
|    세션 생성     |     완료      |
|    세션 삭제     |     완료      |
|     방 입장      |     완료      |
|     방 퇴장      |     완료      |
|     방 채팅      |     완료      |
|    게임 시작     |     완료      |
|     돌 두기      |     완료      |
|  오목 로직 기능  |     완료      |
|    게임 종료     |     완료      |
| 세션 로그인 체크 |     완료      |
|    하트 비트     |     완료      |
|     룸 체크      |     완료      |

### 데이터베이스 기능 구현
|        **기능**         | **완료 여부** |
| :---------------------: | :-----------: |
|  유저 데이터 가져오기   |     완료      |
| 유저 우승 정보 업데이트 |     완료      |

### 레디스 기능 구현
|    **기능**    | **완료 여부** |
| :------------: | :-----------: |
| 토큰 정보 검증 |     완료      |
|   매칭 기능    |     완료      |

## 주요 기능 설명
### 하트 비트 및 세션 체크
- [설정파일](./appsettings.json)을 통해 특정 시간마다 연결되어 있는 클라이언트들이 정말 연결되어 있는지 체크하는 기능
- 타이머마다 접속한 모든 유저에게 하트비트 패킷을 전송함.
- 응답이 오게 되면 해당 시간을 기록함.
- 체크하는 과정에서 시간을 비교하여 특정 시간 이상으로 하트비트 응답이 오지 않은 경우 세션 종료 처리함.
- 한번에 모든 유저를 체크하는 경우 부하가 발생할 수 있기 때문에 특정 카운트만큼 처리하도록 구현함.
- `System.Threading.Timer`를 통해 반복적으로 실행됨.

### 룸 체크
- [설정파일](./appsettings.json)을 통해 특정 시간마다 모든 룸의 상태를 체크하는 기능
- 시간, 체크 횟수 등을 을 통해 설정할 수 있음.
- 다음과 같은 것들을 체크함.
  - 매칭되어 있는 방의 경우 시간을 측정하여 설정 시간보다 지났는데도 게임이 시작되지 않았거나 유저가 들어와있지 않으면 룸을 클리어
  - 게임이 시작했는데 유저가 2명보다 작을 시 룸을 클리어
  - 게임이 시작되었는데 특정 시간보다 더 오래 게임을 진행하고 있을 시 룸을 클리어(값이 매우 큼)
  - 오목 게임 체크
    - 턴을 가진 유저가 설정된 시간을 넘어서 두지 않을 경우 턴이 넘어감
    - 특정 카운트만큼 한 유저가 턴을 강제 넘겨지게 되면 게임 종료
- 한번에 모든 유저를 체크하는 경우 부하가 발생할 수 있기 때문에 특정 카운트만큼 처리하도록 구현함.
- 룸 체크의 경우 `System.Threading.Timer`를 통해 반복적으로 실행됨.

### Inner Packet
- 각 스레드별로 내부 패킷을 만들어서 전송하는 식으로 하여, 각 스레드 간의 간섭을 최소화함.
- 헤더 + 데이터 형식으로 패킷을 만들어 주고 받음.

## 피드백
1. 싱글톤 패턴을 사용하지 않고, Action이나 Func 델리게이트 형식으로 전달받아서 사용해라.
    - 객체 간의 연동은 최대한 느슨하게 하는 것이 좋다.
2. 최대한 심플하게, 유지보수가 쉬운 코드를 작성해라
3. 방어적인 코드를 작성해라
4. 좀비 객체를 조심해라
5. 데이터만 바꿔도 기능이 바뀌도록 구현하는 것이 가장 좋다.
6. MO 서버의 경우, 하나의 스레드로 만들어도 하나의 컴퓨터에 여러 개의 서버를 동시에 띄우면 된다.
7. 서버에는 기본적으로 Sleep, Wait가 있으면 안된다.
8. 데이터의 양이 적은 경우, Dictionary보다 List가 성능이 더 좋을 수도 있다.
9. 실행 중의 IO 작업은 모두 비동기로 작동해야 한다.
10. 연결이 끊기면 다시 재접속해주는 코드가 필요하다.
11. 내가 실수해도 서버가 잘 돌아갈 수 있도록 방어적인 코드를 추가해야 한다.

## 트러블 슈팅